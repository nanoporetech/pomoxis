

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>pomoxis.catalogue_errors &mdash; Pomoxis 0.3.6 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Pomoxis
          

          
          </a>

          
            
            
              <div class="version">
                0.3.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../programs.html">Pomoxis Programs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pomoxis.html">pomoxis package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pomoxis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../pomoxis.html">pomoxis</a> &raquo;</li>
        
      <li>pomoxis.catalogue_errors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pomoxis.catalogue_errors</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">matplotlib</span><span class="p">;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># enforce non-interactive backend</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pysam</span>

<span class="kn">from</span> <span class="nn">pomoxis.util</span> <span class="kn">import</span> <span class="n">get_trimmed_pairs</span><span class="p">,</span> <span class="n">intervaltrees_from_bed</span>

<span class="n">AlignSeg</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;AlignSeg&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;rname&#39;</span><span class="p">,</span> <span class="s1">&#39;qname&#39;</span><span class="p">,</span> <span class="s1">&#39;pairs&#39;</span><span class="p">,</span> <span class="s1">&#39;rlen&#39;</span><span class="p">))</span>
<span class="n">Error</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;rp&#39;</span><span class="p">,</span> <span class="s1">&#39;rname&#39;</span><span class="p">,</span> <span class="s1">&#39;qp&#39;</span><span class="p">,</span> <span class="s1">&#39;qname&#39;</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;match&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="s1">&#39;klass&#39;</span><span class="p">,</span> <span class="s1">&#39;aggr_klass&#39;</span><span class="p">))</span>
<span class="n">Context</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;p_i&#39;</span><span class="p">,</span> <span class="s1">&#39;qb&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

<span class="n">_match_</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
<span class="n">_indel_</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span>
<span class="n">_sub_</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span>

<span class="n">_sep_</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>

<span class="n">_indel_sizes_</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">_error_groups_</span> <span class="o">=</span> <span class="p">[</span>
                  <span class="p">(</span><span class="s1">&#39;HP sub swp&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;HP sub swp&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;HP sub ext&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;HP sub ext&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;HP sub trc&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;HP sub trc&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;sub HP split&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;sub HP split&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ins HP split&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;ins HP split&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;sub HP join&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;sub HP join&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;del HP join&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;del HP join&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;multi ins &gt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;multi .*ins &gt;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))),</span>
                  <span class="p">(</span><span class="s1">&#39;multi ins &lt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;multi .*ins &lt;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))),</span>
                  <span class="p">(</span><span class="s1">&#39;multi del &gt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;multi .*del &gt;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))),</span>
                  <span class="p">(</span><span class="s1">&#39;multi del &lt;&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;multi .*del &lt;&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">))),</span>
                  <span class="p">(</span><span class="s1">&#39;HP del&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;HP del&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;HP ins&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;HP ins&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;HP sub&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;HP sub&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;fwd repeat ins&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;fwd repeat ins&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;rev repeat ins&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;rev repeat ins&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;fwd repeat del&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;fwd repeat del&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;rev repeat del&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;rev repeat del&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;ins&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;ins&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;del&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                  <span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;sub&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
<span class="p">]</span>

<div class="viewcode-block" id="get_errors"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.get_errors">[docs]</a><span class="k">def</span> <span class="nf">get_errors</span><span class="p">(</span><span class="n">aln</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find positions of errors in an aligment.</span>

<span class="sd">    :param aln: iterable of `AlignPos` objects.</span>
<span class="sd">    :param bed_file: path to .bed file of regions to include in analysis.</span>
<span class="sd">    :param tree: `intervaltree.IntervalTree` object of regions to analyse.</span>
<span class="sd">    :returns: ( [(ri, qi, &#39;error_type&#39;, last_ri, last_qi)], aligned_ref_len)</span>
<span class="sd">        ri, qi: ref and query positions</span>
<span class="sd">        error_type: &#39;D&#39;, &#39;I&#39; or &#39;S&#39;</span>
<span class="sd">        last_ri, last_qi: ref and query positions of the last match</span>
<span class="sd">        aligned_ref_len: total aligned reference length (taking account of masking tree)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">err</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_qi</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">last_ri</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">n_masked</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">aligned_ref_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">qi</span><span class="p">,</span> <span class="n">qb</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span> <span class="ow">in</span> <span class="n">aln</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">ri</span> <span class="k">if</span> <span class="n">ri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pos</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tree</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ri</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tree</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="c1"># if ri is None, we are in an insertion, check if pos + 1 overlaps</span>
                <span class="c1"># (ref position of ins is arbitrary)</span>
                <span class="c1"># print(&#39;Skipping ref {}:{}&#39;.format(read.reference_name, pos))</span>
                <span class="n">n_masked</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">qi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># deletion</span>
            <span class="n">last_ri</span> <span class="o">=</span> <span class="n">ri</span>  <span class="c1"># ri will not be None</span>
            <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ri</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">last_ri</span><span class="p">,</span> <span class="n">last_qi</span><span class="p">)))</span>
            <span class="n">aligned_ref_len</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last_qi</span> <span class="o">=</span> <span class="n">qi</span>  <span class="c1"># qi will not be None</span>
            <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ri</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">last_ri</span><span class="p">,</span> <span class="n">last_qi</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_qi</span> <span class="o">=</span> <span class="n">qi</span>
            <span class="n">last_ri</span> <span class="o">=</span> <span class="n">ri</span>
            <span class="k">if</span> <span class="n">qb</span> <span class="o">!=</span> <span class="n">rb</span><span class="p">:</span>
                <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ri</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">last_ri</span><span class="p">,</span> <span class="n">last_qi</span><span class="p">)))</span>
            <span class="n">aligned_ref_len</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="n">aligned_ref_len</span><span class="p">,</span> <span class="n">n_masked</span></div>


<div class="viewcode-block" id="rle"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.rle">[docs]</a><span class="k">def</span> <span class="nf">rle</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate a run length encoding (rle), of an input vector.</span>

<span class="sd">    :param it: iterable.</span>
<span class="sd">    :returns: structured array with fields `start`, `length`, and `value`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">val_dtype</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_gen</span><span class="p">():</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">length</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">key</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">length</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">_gen</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_run"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.get_run">[docs]</a><span class="k">def</span> <span class="nf">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find run to which the i&#39;th element belongs.</span>

<span class="sd">    :param i: int, element index wihin input to `rle`.</span>
<span class="sd">    :returns: int, element index within runs to which i belongs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">runs</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span>
    <span class="n">start_i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">runs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">i</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">end_i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">runs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">][</span><span class="n">start_i</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">ends</span><span class="p">[</span><span class="n">end_i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">run_i</span> <span class="o">=</span> <span class="n">start_i</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">start</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">i</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">end_i</span>

    <span class="k">return</span> <span class="n">run_i</span></div>


<span class="k">def</span> <span class="nf">_get_context_bounds</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aln</span><span class="p">,</span> <span class="n">search_by_q</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find start and en d of context.</span>

<span class="sd">    In the simplest case this will be p-offset:p+offset, but we adjust</span>
<span class="sd">    for boundaries and to ensure we don&#39;t start/end on an error or within a HP.</span>

<span class="sd">    :param p: int, position (ref position, or query position)</span>
<span class="sd">    :param aln: iterable of `AlignPos` objects.</span>
<span class="sd">    :param search_by_q: bool, whether to search by query position (typically done if qi is None).</span>
<span class="sd">    :returns: (int start index, int end index, int index of p within aln[start:end])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">search_by_q</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">qpos</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aln</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">rpos</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aln</span><span class="p">]</span>


    <span class="n">offset_tmp</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="n">start_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">end_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start_p</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end_p</span><span class="p">)</span>
    <span class="c1"># extend context until it does not start/end with an error or in a HP.</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">s_is_match</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">qbase</span> <span class="o">==</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">rbase</span>
        <span class="n">sq_not_hp</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">qbase</span> <span class="o">!=</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">qbase</span>
        <span class="n">sr_not_hp</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rbase</span> <span class="o">!=</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">rbase</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s_is_match</span> <span class="ow">and</span> <span class="n">sq_not_hp</span> <span class="ow">and</span> <span class="n">sr_not_hp</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">e_is_match</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">qbase</span> <span class="o">==</span> <span class="n">aln</span><span class="p">[</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rbase</span>
        <span class="n">eq_not_hp</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">qbase</span> <span class="o">!=</span> <span class="n">aln</span><span class="p">[</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">qbase</span>
        <span class="n">er_not_hp</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">e</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rbase</span> <span class="o">!=</span> <span class="n">aln</span><span class="p">[</span><span class="n">e</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">rbase</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">e_is_match</span> <span class="ow">and</span> <span class="n">eq_not_hp</span> <span class="ow">and</span> <span class="n">er_not_hp</span><span class="p">)</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aln</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">p_i</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p_i</span> <span class="o">-</span> <span class="n">s</span>


<div class="viewcode-block" id="are_adjacent"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.are_adjacent">[docs]</a><span class="k">def</span> <span class="nf">are_adjacent</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;&quot;Check if all int indices in the interable are consecutive.</span>

<span class="sd">    :param inds: iterable of ints</span>
<span class="sd">    :returns: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">adjacent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adjacent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">-</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adjacent</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">adjacent</span></div>


<div class="viewcode-block" id="is_in_hp"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.is_in_hp">[docs]</a><span class="k">def</span> <span class="nf">is_in_hp</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">p_i</span><span class="p">):</span>
    <span class="n">n_indels_fwd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])])</span>
    <span class="n">n_indels_rev</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">seq</span><span class="p">[:</span><span class="n">p_i</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
    <span class="k">if</span> <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">p_is_hp</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span> <span class="o">-</span> <span class="n">n_indels_rev</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span> <span class="o">+</span> <span class="n">n_indels_fwd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p_is_hp</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n_indels_rev</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="n">seq</span><span class="p">[</span><span class="n">p_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">n_indels_fwd</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">p_is_hp</span></div>


<div class="viewcode-block" id="classify_hp_sub"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.classify_hp_sub">[docs]</a><span class="k">def</span> <span class="nf">classify_hp_sub</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">adjacent</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">match_line</span><span class="p">,</span> <span class="n">rb_runs</span><span class="p">,</span>
                    <span class="n">qb_runs</span><span class="p">,</span> <span class="n">qp_is_hp</span><span class="p">,</span> <span class="n">rp_is_hp</span><span class="p">):</span>
    <span class="n">hp_kls</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># sub errors</span>
    <span class="c1"># &#39;swap&#39;, e.g. r TTCCC -&gt; q TTTCC or  r CCTTCCC -&gt; q CTTTTCC</span>
    <span class="c1"># &#39;split&#39;, e.g. r TTTTTT -&gt; q TTCCTT or r TTTTTT -&gt; q TCTTCT</span>
    <span class="c1"># &#39;join&#39;, e.g. r TTCCTT -&gt; TTTTTT</span>
    <span class="c1"># &#39;trunc&#39;, e.g. r TTTTTT -&gt; q TTTTTC, r TTTTTT -&gt; q CTTTTC,</span>
    <span class="c1">#               r TT -&gt; q TC, r TT -&gt; q GC</span>
    <span class="c1"># &#39;ext&#39;, e.g. r TTTTTC -&gt; q TTTTTT</span>
    <span class="n">rp_run_ind</span> <span class="o">=</span> <span class="n">get_run</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">rb_runs</span><span class="p">)</span>
    <span class="n">qp_run_ind</span> <span class="o">=</span> <span class="n">get_run</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb_runs</span><span class="p">)</span>
    <span class="n">rp_run</span> <span class="o">=</span> <span class="n">rb_runs</span><span class="p">[</span><span class="n">rp_run_ind</span><span class="p">]</span>
    <span class="n">qp_run</span> <span class="o">=</span> <span class="n">qb_runs</span><span class="p">[</span><span class="n">qp_run_ind</span><span class="p">]</span>
    <span class="n">sub_rb_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rb_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]]</span>
    <span class="n">sub_qb_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">qb_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]]</span>
    <span class="c1"># find query runs ref position run (if if ref is HP, get q over extent)</span>
    <span class="n">q_run_inds_in_r_run</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">qb_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])])</span>
    <span class="n">q_runs_in_r_run</span> <span class="o">=</span> <span class="n">qb_runs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">q_run_inds_in_r_run</span><span class="p">)]</span>
    <span class="n">r_run_inds_in_q_run</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rb_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])])</span>
    <span class="n">r_runs_in_q_run</span> <span class="o">=</span> <span class="n">rb_runs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">r_run_inds_in_q_run</span><span class="p">)]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">qp_run</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">==</span> <span class="n">rp_run</span><span class="p">[</span><span class="n">cols</span><span class="p">]:</span>
        <span class="c1"># this is a false alarm, though some HP in the context has changed,</span>
        <span class="c1"># it was not as this position</span>
        <span class="k">return</span> <span class="n">hp_kls</span>
    <span class="c1"># if more than 1 query run is in ref run, we have a split / trunc</span>
    <span class="c1"># swap is a special case of truncation in which another HP has gained a base</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_run_inds_in_r_run</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

        <span class="c1"># all subs should belong to same RHP, otherwise we have a mess.</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="n">rp_run_ind</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub_rb_inds</span><span class="p">]):</span>
            <span class="n">hp_start_ind</span> <span class="o">=</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="n">hp_end_ind</span> <span class="o">=</span> <span class="n">hp_start_ind</span> <span class="o">+</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">match_runs</span> <span class="o">=</span> <span class="n">rle</span><span class="p">(</span><span class="n">match_line</span><span class="p">)</span>
            <span class="n">match_sub_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">match_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]]</span>
            <span class="c1"># if subs are not flanking we have a split</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hp_start_ind</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">hp_end_ind</span><span class="p">:</span>
                <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;sub HP split (</span><span class="si">{}{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>

            <span class="c1"># if (possibly multiple adjacent) subs are all flanking the HP</span>
            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">match_sub_inds</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">([</span><span class="n">get_run</span><span class="p">(</span><span class="n">hp_start_ind</span><span class="p">,</span> <span class="n">match_runs</span><span class="p">),</span>
                                                <span class="n">get_run</span><span class="p">(</span><span class="n">hp_end_ind</span><span class="p">,</span> <span class="n">match_runs</span><span class="p">)]):</span>
                <span class="c1"># if query is a HP, this is a swap</span>
                <span class="k">if</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (</span><span class="si">{}{}</span><span class="s1">-&gt;</span><span class="si">{}{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span>
                                                                <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;flk HP sub trc (</span><span class="si">{}{}</span><span class="s1">-&gt;</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span>
                                                        <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;complex HP sub trc (</span><span class="si">{}{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;messy HP sub trc&#39;</span>

    <span class="c1"># if more than 1 ref run is in query run, we have a join or extension</span>
    <span class="c1"># swap is a special case of extension in which another HP has lost a base</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_run_inds_in_q_run</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># all subs should belong to same QHP, else we have a mess</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="n">qp_run_ind</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sub_qb_inds</span><span class="p">]):</span>
            <span class="n">hp_start_ind</span> <span class="o">=</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
            <span class="n">hp_end_ind</span> <span class="o">=</span> <span class="n">hp_start_ind</span> <span class="o">+</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">match_runs</span> <span class="o">=</span> <span class="n">rle</span><span class="p">(</span><span class="n">match_line</span><span class="p">)</span>
            <span class="n">match_sub_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_run</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">match_runs</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]]</span>
            <span class="c1"># if subs are not flanking we have a join</span>
            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hp_start_ind</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">hp_end_ind</span><span class="p">:</span>
                <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;sub HP join (</span><span class="si">{}{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>

            <span class="c1"># if (possibly multiple adjacent) subs are all flanking the HP</span>
            <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">match_sub_inds</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">([</span><span class="n">get_run</span><span class="p">(</span><span class="n">hp_start_ind</span><span class="p">,</span> <span class="n">match_runs</span><span class="p">),</span>
                                                <span class="n">get_run</span><span class="p">(</span><span class="n">hp_end_ind</span><span class="p">,</span> <span class="n">match_runs</span><span class="p">)]):</span>
                <span class="c1"># if ref is a HP, this is a swap</span>
                <span class="k">if</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (</span><span class="si">{}{}</span><span class="s1">-&gt;</span><span class="si">{}{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span>
                                                                <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;flk HP sub ext (</span><span class="si">{}{}</span><span class="s1">-&gt;</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">]),</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;complex HP sub ext (</span><span class="si">{}{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;messy HP sub ext&#39;</span>

    <span class="c1"># if we just have 1 run of each, we might have a complete sub of the HP</span>
    <span class="c1"># e.g. TT-&gt;CC</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_run_inds_in_q_run</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_run_inds_in_r_run</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
            <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (</span><span class="si">{}{}</span><span class="s1">-&gt;</span><span class="si">{}{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">rp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span>
                                                          <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qp_run</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">hp_kls</span></div>


<div class="viewcode-block" id="classify_hp_indel"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.classify_hp_indel">[docs]</a><span class="k">def</span> <span class="nf">classify_hp_indel</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">runs1</span><span class="p">,</span> <span class="n">seq2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look for a specific kind of HP indel that splits or joins two HPs</span>

<span class="sd">    :param p_i: int, index of error</span>
<span class="sd">    :param key: key of error type within errors (should be &#39;ins&#39; or &#39;del&#39;)</span>
<span class="sd">    :param errors: dict of error positions</span>
<span class="sd">    :runs1: np.ndarray, rle encoding of sequence1 (query if deletions</span>
<span class="sd">           join two HPs, or ref if insertions split a HP</span>
<span class="sd">    :seq2: iterable of str of sequence2 (ref if deletions join two HPs,</span>
<span class="sd">           or query if insertions split a HP.</span>
<span class="sd">    :returns: str classification or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># look for deletions in query HPs which indicate two ref HPs are joined.</span>
    <span class="c1"># or look for insertions in ref HPs which split them</span>
    <span class="k">assert</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ins&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">]</span>
    <span class="n">_type_</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ins&#39;</span><span class="p">:</span> <span class="s1">&#39;split&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">:</span> <span class="s1">&#39;join&#39;</span><span class="p">}</span>

    <span class="n">hp_kls</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">p_run_ind</span> <span class="o">=</span> <span class="n">get_run</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">runs1</span><span class="p">)</span>

    <span class="c1"># if ref/query is not a HP, return</span>
    <span class="k">if</span> <span class="n">runs1</span><span class="p">[</span><span class="n">p_run_ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">runs1</span><span class="p">[</span><span class="n">p_run_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not a HP </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runs1</span><span class="p">[</span><span class="n">p_run_ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                                              <span class="n">runs1</span><span class="p">[</span><span class="n">p_run_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">hp_kls</span>

    <span class="c1"># if we have multiple non-adjacent indels, we could have</span>
    <span class="c1"># HP which should be split into &gt;2 runs or HP joined from &gt;2 HPs</span>
    <span class="n">hp_base</span> <span class="o">=</span> <span class="n">runs1</span><span class="p">[</span><span class="n">p_run_ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">runs1</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">hp_base</span><span class="p">]</span>
    <span class="n">run_inds_in_hp</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="n">helper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">p_run_ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))]</span>
    <span class="n">run_inds_in_hp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="n">helper</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">p_run_ind</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">runs1</span><span class="p">)))]</span>
    <span class="n">runs1_in_hp</span> <span class="o">=</span> <span class="n">runs1</span><span class="p">[</span><span class="n">run_inds_in_hp</span><span class="p">]</span>
    <span class="n">runs1_in_hp</span> <span class="o">=</span> <span class="n">runs1_in_hp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">runs1_in_hp</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hp_base</span><span class="p">)]</span>
    <span class="n">hp_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">runs1_in_hp</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">])</span>
    <span class="n">hp_start_ind</span> <span class="o">=</span> <span class="n">runs1_in_hp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
    <span class="n">hp_end_ind</span> <span class="o">=</span> <span class="n">runs1_in_hp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">runs1_in_hp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># check that the HPs in the query and ref actually differ (some insertions</span>
    <span class="c1"># might preserve the HP length e.g. CG--GC -&gt; CGGCGC, in which case the HP</span>
    <span class="c1"># is not a split/join</span>
    <span class="n">runs2_in_hp</span> <span class="o">=</span> <span class="n">rle</span><span class="p">(</span><span class="n">seq2</span><span class="p">[</span><span class="n">hp_start_ind</span><span class="p">:</span> <span class="n">hp_end_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">runs2_in_hp</span> <span class="o">=</span> <span class="n">runs2_in_hp</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">runs2_in_hp</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">runs2_in_hp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
        <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">runs2_in_hp</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hp_len</span><span class="p">,</span>
                              <span class="n">runs2_in_hp</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hp_base</span><span class="p">))):</span>

        <span class="k">return</span> <span class="n">hp_kls</span>

    <span class="c1"># we have a split/join if any indels are within hp</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">hp_start_ind</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hp_end_ind</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="n">key</span><span class="p">]]):</span>
        <span class="c1"># if any indels are outside HP run, we have a mess</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">hp_start_ind</span> <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">hp_end_ind</span><span class="p">:</span>
            <span class="n">subtype</span> <span class="o">=</span> <span class="s1">&#39;messy&#39;</span>
        <span class="k">elif</span> <span class="n">are_adjacent</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">subtype</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subtype</span> <span class="o">=</span> <span class="s1">&#39;multi&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subtype</span> <span class="o">=</span> <span class="s1">&#39;complex&#39;</span>
        <span class="n">hp_kls</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> HP </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subtype</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">_type_</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">hp_base</span><span class="p">,</span> <span class="n">hp_len</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hp_kls</span></div>


<div class="viewcode-block" id="get_match_line_and_err_index"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.get_match_line_and_err_index">[docs]</a><span class="k">def</span> <span class="nf">get_match_line_and_err_index</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">match_line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">qb</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">rb</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">match_line</span> <span class="o">+=</span> <span class="n">_match_</span>
        <span class="k">elif</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">or</span> <span class="n">r</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>  <span class="c1"># indel</span>
            <span class="n">match_line</span> <span class="o">+=</span> <span class="n">_indel_</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;del&#39;</span> <span class="k">if</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="s1">&#39;ins&#39;</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># sub</span>
            <span class="n">match_line</span> <span class="o">+=</span> <span class="n">_sub_</span>
            <span class="n">k</span> <span class="o">=</span> <span class="s1">&#39;sub&#39;</span>
        <span class="k">if</span> <span class="n">match_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_match_</span><span class="p">:</span>
            <span class="n">errors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">context</span><span class="o">.</span><span class="n">p_i</span><span class="p">:</span>  <span class="c1"># this is the central error we are classifying</span>
            <span class="n">p_k</span> <span class="o">=</span> <span class="n">k</span>
    <span class="k">return</span> <span class="n">match_line</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">p_k</span></div>


<div class="viewcode-block" id="preprocess_error"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.preprocess_error">[docs]</a><span class="k">def</span> <span class="nf">preprocess_error</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aln</span><span class="p">,</span> <span class="n">search_by_q</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param p: int, position (ref position, or query position)</span>
<span class="sd">    :param aln: iterable of `AlignPos` objects.</span>
<span class="sd">    :param search_by_q: bool, whether to search by query position (typically done if qi is None).</span>
<span class="sd">    :returns: `Context` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">p_i</span> <span class="o">=</span> <span class="n">_get_context_bounds</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">aln</span><span class="p">,</span> <span class="n">search_by_q</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
    <span class="n">sl</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span>
    <span class="n">qi</span><span class="p">,</span> <span class="n">qb</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sl</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span></div>


<div class="viewcode-block" id="simple_klass"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.simple_klass">[docs]</a><span class="k">def</span> <span class="nf">simple_klass</span><span class="p">(</span><span class="n">adjacent</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">indel_sizes</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">adjacent</span><span class="p">:</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;complex&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="s1">&#39;simple&#39;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;multi&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;ins&#39;</span> <span class="ow">in</span> <span class="n">err_type</span> <span class="ow">or</span> <span class="s1">&#39;del&#39;</span> <span class="ow">in</span> <span class="n">err_type</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">_get_size</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">indel_sizes</span><span class="p">)</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">klass</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">err_type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">klass</span></div>


<div class="viewcode-block" id="classify_error"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.classify_error">[docs]</a><span class="k">def</span> <span class="nf">classify_error</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">indel_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Classify error within an alignment.</span>

<span class="sd">    :param context: `Context` object</span>
<span class="sd">    :indel_sizes: iterable of int, for binning indel sizes.</span>
<span class="sd">        indels &gt;= to indel_sizes[0] will not be considered as HP splitting/joining indels</span>
<span class="sd">    :returns: (str reference_context,</span>
<span class="sd">               str match_line,</span>
<span class="sd">               str query_context,</span>
<span class="sd">               dict counts of sub/ins/del within context)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">indel_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indel_sizes</span> <span class="o">=</span> <span class="n">_indel_sizes_</span>

    <span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">context</span>
    <span class="n">match_line</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">p_k</span> <span class="o">=</span> <span class="n">get_match_line_and_err_index</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="c1"># find homopolymers within context</span>
    <span class="n">qb_runs</span> <span class="o">=</span> <span class="n">rle</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">qb</span><span class="p">])</span>
    <span class="n">rb_runs</span> <span class="o">=</span> <span class="n">rle</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">rb</span><span class="p">])</span>
    <span class="n">qb_hps</span> <span class="o">=</span> <span class="n">qb_runs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">qb_runs</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">rb_hps</span> <span class="o">=</span> <span class="n">rb_runs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rb_runs</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]</span>
    <span class="n">hp_changed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qb_hps</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rb_hps</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">qb_hps</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rb_hps</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
    <span class="c1"># hp might also be changed if we have an ins in the middle of a ref hp</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hp_changed</span><span class="p">:</span>
        <span class="n">hp_changed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([(</span><span class="n">rb_runs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span>
                           <span class="n">rb_runs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">rb_runs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rb_runs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="c1"># hp might also be changed if we have an del in the middle of a query hp</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hp_changed</span><span class="p">:</span>
        <span class="n">hp_changed</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([(</span><span class="n">qb_runs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span>
                           <span class="n">qb_runs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">qb_runs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qb_runs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="n">hp_kls</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Try to class the error, make it up as we go along!</span>
    <span class="n">dels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">])</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;ins&#39;</span><span class="p">])</span>
    <span class="n">indels</span> <span class="o">=</span> <span class="n">dels</span> <span class="o">+</span> <span class="n">ins</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span>
    <span class="c1"># is this position part of a hp in query or ref?</span>
    <span class="n">qp_is_hp</span> <span class="o">=</span> <span class="n">is_in_hp</span><span class="p">(</span><span class="n">qb</span><span class="p">,</span> <span class="n">p_i</span><span class="p">)</span>
    <span class="n">rp_is_hp</span> <span class="o">=</span> <span class="n">is_in_hp</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="n">p_i</span><span class="p">)</span>
    <span class="n">hp_subtypes</span> <span class="o">=</span> <span class="p">{(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span> <span class="s1">&#39;RHP&#39;</span><span class="p">,</span>
                   <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;QHP&#39;</span><span class="p">,</span>
                   <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="s1">&#39;HP&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">hp_subtype</span> <span class="o">=</span> <span class="n">hp_subtypes</span><span class="p">[(</span><span class="n">rp_is_hp</span><span class="p">,</span> <span class="n">qp_is_hp</span><span class="p">)]</span>
    <span class="n">err_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hp_subtype</span><span class="p">,</span> <span class="n">p_k</span><span class="p">)</span> <span class="k">if</span> <span class="n">hp_subtype</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">p_k</span>
    <span class="n">kls</span> <span class="o">=</span> <span class="s1">&#39;unknown (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">subs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">indels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ins</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dels</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">kls</span> <span class="o">=</span> <span class="s1">&#39;complex mess (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err_type</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">indels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># we have a sub</span>
        <span class="n">adjacent</span> <span class="o">=</span> <span class="n">are_adjacent</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])</span>
        <span class="n">kls</span> <span class="o">=</span> <span class="n">simple_klass</span><span class="p">(</span><span class="n">adjacent</span><span class="p">,</span> <span class="n">subs</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">indel_sizes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hp_changed</span><span class="p">:</span>
            <span class="n">hp_kls</span> <span class="o">=</span> <span class="n">classify_hp_sub</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="n">adjacent</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">match_line</span><span class="p">,</span> <span class="n">rb_runs</span><span class="p">,</span>
                                     <span class="n">qb_runs</span><span class="p">,</span> <span class="n">qp_is_hp</span><span class="p">,</span> <span class="n">rp_is_hp</span><span class="p">)</span>
            <span class="n">kls</span> <span class="o">=</span> <span class="n">hp_kls</span> <span class="k">if</span> <span class="n">hp_kls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kls</span>

    <span class="k">elif</span> <span class="n">dels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">adjacent</span> <span class="o">=</span> <span class="n">are_adjacent</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;ins&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">hp_changed</span> <span class="ow">and</span> <span class="n">ins</span> <span class="o">&lt;</span> <span class="n">indel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">hp_kls</span> <span class="o">=</span> <span class="n">classify_hp_indel</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="s1">&#39;ins&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">rb_runs</span><span class="p">,</span> <span class="n">qb</span><span class="p">)</span>
            <span class="n">kls</span> <span class="o">=</span> <span class="n">hp_kls</span> <span class="k">if</span> <span class="n">hp_kls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kls</span>
        <span class="k">if</span> <span class="n">hp_kls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kls</span> <span class="o">=</span> <span class="n">simple_klass</span><span class="p">(</span><span class="n">adjacent</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">indel_sizes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adjacent</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;ins&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">qb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">q_hp_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="n">b</span><span class="p">,</span> <span class="n">qb</span><span class="p">[</span><span class="n">i</span><span class="p">:])])</span>
                <span class="n">r_hp_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="n">b</span><span class="p">,</span> <span class="n">rb</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">ins</span><span class="p">:])])</span>
                <span class="n">inserted</span> <span class="o">=</span> <span class="n">qb</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">ins</span><span class="p">]</span>
                <span class="c1"># get ref_after insertions to check if we have a repeat</span>
                <span class="n">repeat_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ins</span>
                <span class="n">repeat_end</span> <span class="o">=</span> <span class="n">repeat_start</span> <span class="o">+</span> <span class="n">ins</span>
                <span class="k">if</span> <span class="n">repeat_end</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rb</span><span class="p">):</span>
                    <span class="n">ref_after</span> <span class="o">=</span> <span class="n">rb</span><span class="p">[</span><span class="n">repeat_start</span><span class="p">:</span> <span class="n">repeat_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># we don&#39;t have enough context after the insertion</span>
                    <span class="n">ref_after</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">q_hp_len</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">r_hp_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">qb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span> <span class="ow">and</span> <span class="n">rb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;ins&#39;</span><span class="p">]]):</span>
                    <span class="n">kls</span> <span class="o">=</span> <span class="s2">&quot;HP ins (</span><span class="si">{}{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">r_hp_len</span><span class="p">,</span> <span class="n">q_hp_len</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">inserted</span> <span class="o">==</span> <span class="n">ref_after</span><span class="p">:</span>
                    <span class="n">kls</span> <span class="o">=</span> <span class="s2">&quot;fwd repeat ins len </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">inserted</span> <span class="o">==</span> <span class="n">ref_after</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">kls</span> <span class="o">=</span> <span class="s2">&quot;rev repeat ins len </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ins</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">adjacent</span> <span class="o">=</span> <span class="n">are_adjacent</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">hp_changed</span> <span class="ow">and</span> <span class="n">dels</span> <span class="o">&lt;</span> <span class="n">indel_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">hp_kls</span> <span class="o">=</span> <span class="n">classify_hp_indel</span><span class="p">(</span><span class="n">p_i</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">qb_runs</span><span class="p">,</span> <span class="n">rb</span><span class="p">)</span>
            <span class="n">kls</span> <span class="o">=</span> <span class="n">hp_kls</span> <span class="k">if</span> <span class="n">hp_kls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kls</span>
        <span class="k">if</span> <span class="n">hp_kls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kls</span> <span class="o">=</span> <span class="n">simple_klass</span><span class="p">(</span><span class="n">adjacent</span><span class="p">,</span> <span class="n">dels</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">indel_sizes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adjacent</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">rb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># we use aln_rb instead of rb, so we can find the length</span>
                <span class="c1"># of HPs which extent beyond the context.</span>
                <span class="n">hp_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">==</span><span class="n">b</span><span class="p">,</span> <span class="n">rb</span><span class="p">[</span><span class="n">i</span><span class="p">:])])</span>
                <span class="n">deleted</span> <span class="o">=</span> <span class="n">rb</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">dels</span><span class="p">]</span>
                <span class="c1"># get ref_after deletions to check if we have a repeat</span>
                <span class="n">repeat_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">dels</span>
                <span class="n">repeat_end</span> <span class="o">=</span> <span class="n">repeat_start</span> <span class="o">+</span> <span class="n">dels</span>
                <span class="k">if</span> <span class="n">repeat_end</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rb</span><span class="p">):</span>
                    <span class="n">ref_after</span> <span class="o">=</span> <span class="n">rb</span><span class="p">[</span><span class="n">repeat_start</span><span class="p">:</span> <span class="n">repeat_end</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># we don&#39;t have enough context after the insertion</span>
                    <span class="n">ref_after</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">hp_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">rb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">]]):</span>
                        <span class="n">kls</span> <span class="o">=</span> <span class="s2">&quot;HP del (</span><span class="si">{}{}</span><span class="s2">-&gt;</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">hp_len</span><span class="p">,</span> <span class="n">hp_len</span> <span class="o">-</span> <span class="n">dels</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">deleted</span> <span class="o">==</span> <span class="n">ref_after</span><span class="p">:</span>
                    <span class="n">kls</span> <span class="o">=</span> <span class="s2">&quot;fwd repeat del len </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dels</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">deleted</span> <span class="o">==</span> <span class="n">ref_after</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">kls</span> <span class="o">=</span> <span class="s2">&quot;rev repeat del len </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dels</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rb</span><span class="p">),</span> <span class="n">match_line</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">errors</span><span class="p">,</span> <span class="n">kls</span></div>


<span class="k">def</span> <span class="nf">_get_size</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">sizes</span><span class="p">):</span>
    <span class="n">l_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l_i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sizes</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;&lt;= </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">l_i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">size</span>


<span class="k">def</span> <span class="nf">_process_read</span><span class="p">(</span><span class="n">bam</span><span class="p">,</span> <span class="n">read_num</span><span class="p">,</span> <span class="n">bed_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load an alignment from bam and return result of `_process_seg`.</span>

<span class="sd">    :param bam: str, bam file.</span>
<span class="sd">    :param read_num: int, index of alignment to process.</span>
<span class="sd">    :param bed_file: path to .bed file of regions to include in analysis.</span>
<span class="sd">    :returns: result of `_process_seg`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trees</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">bed_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="n">intervaltrees_from_bed</span><span class="p">(</span><span class="n">bed_file</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pysam</span><span class="o">.</span><span class="n">AlignmentFile</span><span class="p">(</span><span class="n">bam</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bam_obj</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">bam_obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">read_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">is_unmapped</span> <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">is_supplementary</span> <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">is_secondary</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">bed_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">trees</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">reference_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">tree</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">reference_start</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">reference_end</span><span class="p">):</span>
                <span class="c1">#sys.stderr.write(&#39;read {} does not overlap with any regions in bedfile\n&#39;.format(rec.query_name))</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">seg</span> <span class="o">=</span> <span class="n">AlignSeg</span><span class="p">(</span><span class="n">rname</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">reference_name</span><span class="p">,</span> <span class="n">qname</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">query_name</span><span class="p">,</span>
                       <span class="n">pairs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">get_trimmed_pairs</span><span class="p">(</span><span class="n">rec</span><span class="p">)),</span> <span class="n">rlen</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">reference_length</span>
                      <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Loaded query </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">qname</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_process_seg</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process_seg</span><span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Classify and count errors within an `AlignSeg` object.</span>

<span class="sd">    :param seg: `AlignSeg` object.</span>
<span class="sd">    :param tree: `intervaltree.IntervalTree` object of regions to analyse.</span>
<span class="sd">    :returns: (seg.rname, aligned_ref_len, error_count, errors, n_masked)</span>
<span class="sd">        error_count: `Counter` of error classes</span>
<span class="sd">        errors: list of `Error` objects</span>
<span class="sd">        n_masked: number of reference positions excluded by tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pos_and_errors</span><span class="p">,</span> <span class="n">aligned_ref_len</span><span class="p">,</span> <span class="n">n_masked</span> <span class="o">=</span> <span class="n">get_errors</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ri</span><span class="p">,</span> <span class="n">qi</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">approx_pos</span> <span class="ow">in</span> <span class="n">pos_and_errors</span><span class="p">:</span>
        <span class="n">ref</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">preprocess_error</span><span class="p">(</span>
            <span class="n">ri</span> <span class="k">if</span> <span class="n">ri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">qi</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span> <span class="n">search_by_q</span><span class="o">=</span><span class="p">(</span><span class="n">ri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="n">rp</span> <span class="o">=</span> <span class="n">ri</span>
        <span class="n">qp</span> <span class="o">=</span> <span class="n">qi</span>
        <span class="k">if</span> <span class="n">rp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="s2">&quot;~</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">approx_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">qp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qp</span> <span class="o">=</span> <span class="s2">&quot;~</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">approx_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="n">rp</span><span class="o">=</span><span class="n">rp</span><span class="p">,</span> <span class="n">rname</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">rname</span><span class="p">,</span> <span class="n">qp</span><span class="o">=</span><span class="n">qp</span><span class="p">,</span> <span class="n">qname</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">qname</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                            <span class="n">match</span><span class="o">=</span><span class="n">match</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="n">read</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="n">counts</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="n">klass</span><span class="p">,</span>
                            <span class="n">aggr_klass</span><span class="o">=</span><span class="n">get_aggr_klass</span><span class="p">(</span><span class="n">klass</span><span class="p">)))</span>
        <span class="n">error_count</span><span class="p">[</span><span class="n">klass</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">seg</span><span class="o">.</span><span class="n">rlen</span> <span class="o">==</span> <span class="n">aligned_ref_len</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Done processing </span><span class="si">{}</span><span class="s1"> aligned to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">qname</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">rname</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">seg</span><span class="o">.</span><span class="n">rname</span><span class="p">,</span> <span class="n">aligned_ref_len</span><span class="p">,</span> <span class="n">error_count</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">n_masked</span>


<div class="viewcode-block" id="qscore"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.qscore">[docs]</a><span class="k">def</span> <span class="nf">qscore</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate a qscore&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># some values might be zero</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">q</span></div>


<div class="viewcode-block" id="analyze_counts"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.analyze_counts">[docs]</a><span class="k">def</span> <span class="nf">analyze_counts</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">total_ref_length</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;klass&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                       <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">())})</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;err_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_ref_length</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fraction_of_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;remaining_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;remaining_err_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;err_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;err_rate_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qscore</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;err_rate&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;remaining_err_rate_q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qscore</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;remaining_err_rate&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;remaining_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="plot_summary"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.plot_summary">[docs]</a><span class="k">def</span> <span class="nf">plot_summary</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">ref_len</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a plot showing Q-scores as largest remaining</span>
<span class="sd">    error klass is removed&quot;&quot;&quot;</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">y_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">no_error_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">ref_len</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;remaining_err_rate_q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">no_error_score</span><span class="p">)),</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Q(Accuracy)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Error Class&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">y_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_pos</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s1">&#39;total error&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;klass&#39;</span><span class="p">]))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>  <span class="c1"># labels read top-to-bottom</span>
    <span class="n">xstart</span><span class="p">,</span> <span class="n">xend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">ystart</span><span class="p">,</span> <span class="n">yend</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xend</span> <span class="o">-</span> <span class="mf">2.25</span><span class="p">,</span> <span class="n">ystart</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Q-score after removing error class&#39;</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_remaining_errors.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_aggr_counts"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.get_aggr_counts">[docs]</a><span class="k">def</span> <span class="nf">get_aggr_counts</span><span class="p">(</span><span class="n">total_counts</span><span class="p">):</span>
    <span class="c1"># get errors per type</span>
    <span class="n">aggregate_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="n">max_indel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_indel_sizes_</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">total_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">aggregate_counts</span><span class="p">[</span><span class="n">get_aggr_klass</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">aggregate_counts</span></div>


<div class="viewcode-block" id="get_aggr_klass"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.get_aggr_klass">[docs]</a><span class="k">def</span> <span class="nf">get_aggr_klass</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
    <span class="n">max_indel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_indel_sizes_</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">error_type</span><span class="p">,</span> <span class="n">is_type</span> <span class="ow">in</span> <span class="n">_error_groups_</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_type</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">in</span> <span class="n">error_type</span> <span class="ow">or</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">error_type</span><span class="p">:</span>
                <span class="n">aggr_klass</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">max_indel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aggr_klass</span> <span class="o">=</span> <span class="n">error_type</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">aggr_klass</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;[</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;catalogue_errors&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Create a catalogue of all query errors in a bam.&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;bam&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Input alignments (aligned to ref).&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--bed&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;.bed file of reference regions to include.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of threads for parallel execution.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--outdir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;error_catalogue&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output directory.&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pysam</span><span class="o">.</span><span class="n">AlignmentFile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">bam</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bam</span><span class="p">:</span>
        <span class="n">n_reads</span> <span class="o">=</span> <span class="n">bam</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="n">total_ref_length</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">total_n_ref_sites_masked</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">error_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Counter</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_process_read</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">bam</span><span class="p">,</span> <span class="n">bed_file</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">bed</span><span class="p">)</span>

    <span class="c1"># record draft start position of each long multi indel</span>
    <span class="n">multi_errs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># make an approximate position into int</span>
    <span class="n">helper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">db_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;error_catalogue_db.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">txt_fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;error_catalogue.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;ref_name&#39;</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;rname&#39;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;ref_pos&#39;</span><span class="p">,</span> <span class="n">helper</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;rp&#39;</span><span class="p">))),</span>
                <span class="p">(</span><span class="s1">&#39;ref_context&#39;</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;query_name&#39;</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;qname&#39;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;query_pos&#39;</span><span class="p">,</span> <span class="n">helper</span><span class="p">(</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;qp&#39;</span><span class="p">))),</span>
                <span class="p">(</span><span class="s1">&#39;query_context&#39;</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;aggr_class&#39;</span><span class="p">,</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;aggr_klass&#39;</span><span class="p">)),</span>
                <span class="p">(</span><span class="s1">&#39;n_ins&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;ins&#39;</span><span class="p">])),</span>
                <span class="p">(</span><span class="s1">&#39;n_del&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;del&#39;</span><span class="p">])),</span>
                <span class="p">(</span><span class="s1">&#39;n_sub&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">counts</span><span class="p">[</span><span class="s1">&#39;sub&#39;</span><span class="p">])),</span>
                <span class="p">(</span><span class="s1">&#39;context_len&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">ref</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="n">db_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_sep_</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">returned</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reads</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">returned</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_name</span><span class="p">,</span> <span class="n">ref_length</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">n_masked</span> <span class="o">=</span> <span class="n">returned</span>
            <span class="n">error_count</span><span class="p">[</span><span class="n">ref_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
            <span class="n">total_ref_length</span><span class="p">[</span><span class="n">ref_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ref_length</span>
            <span class="n">total_n_ref_sites_masked</span><span class="p">[</span><span class="n">ref_name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">n_masked</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">db_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_sep_</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">e</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">txt_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Ref Pos: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> Pos </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">rp</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">qname</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">qp</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">aggr_klass</span><span class="p">))</span>
                <span class="n">txt_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">ref</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">txt_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">match</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">txt_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">read</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">txt_fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">total_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
    <span class="n">aggr_by_ref</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ref_name</span><span class="p">,</span> <span class="n">counts</span> <span class="ow">in</span> <span class="n">error_count</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">analyze_counts</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">total_ref_length</span><span class="p">[</span><span class="n">ref_name</span><span class="p">])</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_error_summary.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_name</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">_sep_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">aggr_by_ref</span><span class="p">[</span><span class="n">ref_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_aggr_counts</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">analyze_counts</span><span class="p">(</span><span class="n">aggr_by_ref</span><span class="p">[</span><span class="n">ref_name</span><span class="p">],</span> <span class="n">total_ref_length</span><span class="p">[</span><span class="n">ref_name</span><span class="p">])</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_aggr_error_summary.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_name</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">_sep_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plot_summary</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_aggr&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref_name</span><span class="p">),</span>
                     <span class="n">ref_len</span><span class="o">=</span><span class="n">total_ref_length</span><span class="p">[</span><span class="n">ref_name</span><span class="p">])</span>

        <span class="n">total_counts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">analyze_counts</span><span class="p">(</span><span class="n">total_counts</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">total_ref_length</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_error_summary.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">_sep_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">aggregate_counts</span> <span class="o">=</span> <span class="n">get_aggr_counts</span><span class="p">(</span><span class="n">total_counts</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">analyze_counts</span><span class="p">(</span><span class="n">aggregate_counts</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">total_ref_length</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_aggr_error_summary.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">_sep_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plot_summary</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_aggr&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">),</span>
                 <span class="n">ref_len</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">total_ref_length</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="c1"># save counts to yaml for any further analysis</span>
    <span class="n">to_save</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ref_lengths&#39;</span><span class="p">:</span> <span class="n">total_ref_length</span><span class="p">,</span>
               <span class="s1">&#39;n_ref_sites_masked&#39;</span><span class="p">:</span> <span class="n">total_n_ref_sites_masked</span><span class="p">,</span>
               <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;by_ref&#39;</span><span class="p">:</span> <span class="n">error_count</span><span class="p">,</span>
                          <span class="s1">&#39;by_ref_aggr&#39;</span><span class="p">:</span> <span class="n">aggr_by_ref</span><span class="p">,</span>
                          <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total_counts</span><span class="p">,</span>
                          <span class="s1">&#39;total_aggr&#39;</span><span class="p">:</span> <span class="n">aggregate_counts</span><span class="p">,</span>
                         <span class="p">}</span>
               <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;counts.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
         <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">to_save</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>

    <span class="n">db_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">txt_fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All done, check </span><span class="si">{}</span><span class="s1"> for output.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="p">))</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>


<div class="viewcode-block" id="ClassifyErrorTest"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest">[docs]</a><span class="k">class</span> <span class="nc">ClassifyErrorTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

<div class="viewcode-block" id="ClassifyErrorTest.setUp"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ClassifyErrorTest.test_hp_del_6_5"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_hp_del_6_5">[docs]</a>    <span class="k">def</span> <span class="nf">test_hp_del_6_5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACAACAGCAGAAAAAACAGGA&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACAACAGCAG-AAAAACAGGA&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP del (A6-&gt;5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_hp_del_2_0"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_hp_del_2_0">[docs]</a>    <span class="k">def</span> <span class="nf">test_hp_del_2_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CACTTTCGGCTTGAGGATCA&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CACTTTCGGC--GAGGATCA&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP del (T2-&gt;0)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_multi_ins"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_multi_ins">[docs]</a>    <span class="k">def</span> <span class="nf">test_multi_ins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ATGTAATGCC---AAGCTTA&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ATGTAATGCCAGAAAGCTT&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi ins &lt;= 5&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_multi_del"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_multi_del">[docs]</a>    <span class="k">def</span> <span class="nf">test_multi_del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ATGTAATGCCAGAAAGCTT&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ATGTAATGCC---AAGCTTA&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi del &lt;= 5&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_hp_ins"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_hp_ins">[docs]</a>    <span class="k">def</span> <span class="nf">test_hp_ins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CACCTGGTGC-AAAAGAGAG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CACCTGGTGCAAAAAGAGAG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP ins (A4-&gt;5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_sub_split"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_sub_split">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_sub_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;TAATCTGGCCcCTGCAATGC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;TAATCTGGCCTCTGCAATGC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;sub HP split (C4)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_sub_swap_trc"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_sub_swap_trc">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_sub_swap_trc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTACCtTTTGTATAAT&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTACCCTTTGTATAAT&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (T4-&gt;C2,1)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_sub_swap_trc2"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_sub_swap_trc2">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_sub_swap_trc2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTACCttTTGTATAAT&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTACCCCTTGTATAAT&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (T4-&gt;C2,2)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">test_HP_sub_swap_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTACcTTTTGTATAAT&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTACTTTTTGTATAAT&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (T4-&gt;C2,1)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_sub_swap_ext"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_sub_swap_ext">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_sub_swap_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTAccTTTTGTATAAT&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACTGCGTATTTTTTGTATAAT&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (C2-&gt;T4,2)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_swap_sub_trc"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_swap_sub_trc">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_swap_sub_trc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGCCTTCCCCtTGCCATTCA&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGCCTTCCCCCTGCCATTCA&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (T2-&gt;C4,1)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_flk_sub_trc"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_flk_sub_trc">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_flk_sub_trc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGAGAAAATCgGGATCGTTG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGAGAAAATCAGGATCGTTG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;flk HP sub trc (G3-&gt;2)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_flk_sub_ext"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_flk_sub_ext">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_flk_sub_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ATGCAACAAGcTTACGCTGC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ATGCAACAAGTTTACGCTGC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;flk HP sub ext (T2-&gt;3)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_complex_sub"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_complex_sub">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_complex_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGAGAAAAAAAGGATCGTTG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGAGTATAAAAGGATCGTTG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;complex HP sub trc (A7)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_messy_sub"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_messy_sub">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_messy_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CTAaACtGCcGTG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CTACACCGCTGTG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;messy HP sub trc&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_sub_join"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_sub_join">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_sub_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;AGGAACGAATcTCTGAAGCG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;AGGAACGAATTTCTGAAGCG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;sub HP join (T3)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_not_complete_sub"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_not_complete_sub">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_not_complete_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;AGGAACGAATTTCTGAAGCG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;AGGAACGAACCCCTGAAGCG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (T3-&gt;C1,3)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_complete_sub"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_complete_sub">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_complete_sub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;AGGAACGAATTTGTGAAGCG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;AGGAACGAACCCGTGAAGCG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;HP sub swp (T3-&gt;C0,3)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_messy_sub_ext"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_messy_sub_ext">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_messy_sub_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTTctTTTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTTTCTTTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;messy HP sub ext&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_del_join"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_del_join">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_del_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTTCTTTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTT-TTTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;simple del HP join (T8)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_del_join2"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_del_join2">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_del_join2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTTCCTTTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTT--TTTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi del HP join (T8)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_del_join3"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_del_join3">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_del_join3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTTCATTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTT--TTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi del HP join (T7)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_del_join4"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_del_join4">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_del_join4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTTTCATTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGG-TCTTTT--TTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;messy del HP join (T7)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_ins_split"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_ins_split">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_ins_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTT-TTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTGTTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;simple ins HP split (T5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_ins_split2"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_ins_split2">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_ins_split2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTT--TTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTGGTTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi ins HP split (T5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_ins_split3"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_ins_split3">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_ins_split3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTT--TTTCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTGATTTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi ins HP split (T5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_ins_split4"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_ins_split4">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_ins_split4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTT--TT-TCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGTCTTGATTGTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;complex ins HP split (T5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_ins_split5"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_ins_split5">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_ins_split5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;CGGG-TCTT--TT-TCATC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;CGGGGTCTTGATTGTCATC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;messy ins HP split (T5)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">test_fwd_repeat_ins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACCTATAACG--GCGCGCTG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACCTATAACGGCGCGCGCTG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;fwd repeat ins len 2&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<div class="viewcode-block" id="ClassifyErrorTest.test_fwd_repeat_ins"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_fwd_repeat_ins">[docs]</a>    <span class="k">def</span> <span class="nf">test_fwd_repeat_ins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACCTATAACG--GCGCGCTG&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACCTATAACGCGGCGCGCTG&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;rev repeat ins len 2&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_HP_ins_split6"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_HP_ins_split6">[docs]</a>    <span class="k">def</span> <span class="nf">test_HP_ins_split6</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;GCCGATTTTT-TCTCCCGTA&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;GCCGATTTTTCTCTCCCGTA&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;simple ins HP split (T6)&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_complex_HP_del"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_complex_HP_del">[docs]</a>    <span class="k">def</span> <span class="nf">test_complex_HP_del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;AGGGGGGGGACTTGAACCCCCACGTC&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;A-GGGGGGGACTTGAA-CCCCACGTC&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;complex RHP del &lt;= 5&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_long_multi_del"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_long_multi_del">[docs]</a>    <span class="k">def</span> <span class="nf">test_long_multi_del</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACCCACACACCACACCCACACACCACACCCACACCACACCCACACCACACCCACACACCACACCCACACCACACCCACACACCACACCCACACACCACACCCACACCACACCCACACCACACCCACACACCACACCACACCCACACACCCACACACCACACACTCTCTTACATCTACCTCTACTCTCGCTGTCACACCTTACCCGGCTTTCTGACCGAAATTAAAAAAAATGAAAATGAAATCCTCTTCTTTAGCCCTACAACACTTTTACATAGCCCTAAATAGCCCTAAATAGCCCTCATGTACGTCTCCTCCAAGCCCTATTGACTCTTACCCGGAGTTTCAGCTAAAGGCTATACTTACT&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACCCACACACCA---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi del &gt; 100&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClassifyErrorTest.test_long_multi_ins"><a class="viewcode-back" href="../../pomoxis.html#pomoxis.catalogue_errors.ClassifyErrorTest.test_long_multi_ins">[docs]</a>    <span class="k">def</span> <span class="nf">test_long_multi_ins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="s1">&#39;ACCCACACACCA---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T&#39;</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="s1">&#39;ACCCACACACCACACCCACACACCACACCCACACCACACCCACACCACACCCACACACCACACCCACACCACACCCACACACCACACCCACACACCACACCCACACCACACCCACACCACACCCACACACCACACCACACCCACACACCCACACACCACACACTCTCTTACATCTACCTCTACTCTCGCTGTCACACCTTACCCGGCTTTCTGACCGAAATTAAAAAAAATGAAAATGAAATCCTCTTCTTTAGCCCTACAACACTTTTACATAGCCCTAAATAGCCCTAAATAGCCCTCATGTACGTCTCCTCCAAGCCCTATTGACTCTTACCCGGAGTTTCAGCTAAAGGCTATACTTACT&#39;</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;multi ins &gt; 100&#39;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">classify_error</span><span class="p">(</span><span class="n">Context</span><span class="p">(</span><span class="n">p_i</span><span class="o">=</span><span class="n">p_i</span><span class="p">,</span> <span class="n">qb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qb</span><span class="p">),</span> <span class="n">rb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">rb</span><span class="p">)))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Oxford Nanopore Technologies.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>